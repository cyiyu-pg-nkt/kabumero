# server.py
# Requirements:
#   pip install flask yfinance flask-cors

from flask import Flask, jsonify
from flask_cors import CORS
import yfinance as yf
import datetime

app = Flask(__name__)
CORS(app)  # allow requests from your local HTML or GitHub Pages

@app.route("/stock/<symbol>")
def stock(symbol):
    # Get past 6 hours of 1-minute data
    end = datetime.datetime.now()
    start = end - datetime.timedelta(hours=6)
    ticker = yf.Ticker(symbol)

    # Try to fetch; if empty, return an error
    data = ticker.history(interval="1m", start=start, end=end)
    if data is None or len(data) == 0:
        return jsonify({"error": "no data"}), 404

    # Return close prices as a simple list
    prices = data["Close"].tolist()
    return jsonify(prices)

if __name__ == "__main__":
    # Run local server
    app.run(host="0.0.0.0", port=5000)
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>株メロ♪ | 6時間の株価で短い曲</title>
  <style>
    :root {
      --bg: #21213a;
      --panel: #2c2c4f;
      --accent-pink: #ff72b6;
      --accent-cyan: #6df0ff;
      --accent-yellow: #ffe66d;
      --accent-green: #96ff7c;
      --white: #fff7fb;
      --shadow: rgba(0,0,0,0.35);
      --btn-grad: linear-gradient(135deg, #ff72b6 0%, #ffe66d 100%);
      --ring-grad: conic-gradient(from 0deg, #ff72b6, #6df0ff, #96ff7c, #ffe66d, #ff72b6);
    }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--white); font-family:"Segoe UI","Yu Gothic UI",system-ui; }
    .container { max-width:960px; margin:auto; padding:20px; }
    header { text-align:center; }
    .title { font-size:40px; font-weight:bold; background:var(--btn-grad); color:#1c1230; padding:10px 20px; border-radius:16px; display:inline-block; }
    .catch { color:var(--accent-yellow); margin-top:8px; }
    .sub { font-size:14px; margin-top:6px; color:#e9d8ff; }
    .stage { display:flex; gap:20px; margin-top:20px; flex-wrap:wrap; }
    .machine,.info { flex:1; min-width:280px; background:var(--panel); border-radius:16px; padding:20px; box-shadow:0 8px 20px var(--shadow); }
    .ring { width:200px; height:200px; margin:auto; border-radius:50%; background:var(--ring-grad); animation:spin 8s linear infinite; position:relative; }
    .capsule { width:140px; height:140px; border-radius:50%; background:radial-gradient(closest-side,rgba(255,255,255,0.7),rgba(255,255,255,0.05)); position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); }
    @keyframes spin { to { transform:rotate(360deg); } }
    .btn { margin-top:20px; padding:12px 20px; border:none; border-radius:14px; background:var(--btn-grad); font-weight:bold; cursor:pointer; color:#1c1230; }
    .results { margin-top:20px; display:flex; gap:16px; flex-wrap:wrap; }
    .card { flex:1; min-width:280px; background:#353565; border-radius:14px; padding:12px; }
    .card h4 { margin:0 0 6px; color:var(--accent-yellow); }
    .badge { background:var(--accent-green); padding:4px 8px; border-radius:8px; color:#102010; display:inline-block; }
    .timeSig { background:var(--accent-cyan); padding:4px 8px; border-radius:8px; color:#0b1c22; display:inline-block; margin-left:8px; }
    .label { color:#cfd3ff; font-size:12px; margin-top:8px; display:block; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:8px; }
    .input { padding:8px; border-radius:10px; border:1px solid #6666aa; background:#2a2a4a; color:#fff; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">株メロ♪</div>
      <div class="catch">株価の値動きで意外な音楽ができちゃう！</div>
      <div class="sub">過去6時間の株価（1分足）を取り込み、短いフレーズを自動生成します。</div>
    </header>

    <div class="stage">
      <section class="machine">
        <div class="ring"><div class="capsule"></div></div>
        <div class="row">
          <label class="label">銘柄コード（Yahoo形式）例: 7203.T, 6758.T</label>
          <input id="symbolInput" class="input" value="7203.T" />
        </div>
        <button id="rollBtn" class="btn">カプセルトイを回す</button>
      </section>
      <aside class="info">
        <p>ボタンをタップすると、APIから株価を取得して約10秒程度のフレーズを生成します。</p>
        <p>スマホ対応: 初回タップ時に音声エンジンが有効化されます（自動再生制限回避）。</p>
      </aside>
    </div>

    <section class="results" id="results"></section>
  </div>

  <script>
    // ===== Audio initialization (mobile-safe) =====
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    let audioCtx = null;
    function ensureAudio() {
      if (!audioCtx) audioCtx = new AudioCtx({ latencyHint: "interactive" });
      if (audioCtx.state === "suspended") {
        audioCtx.resume().catch(() => {});
      }
    }

    // ===== Fetch 6-hour minute data from local server =====
    async function fetchStock(symbol) {
      const url = `http://localhost:5000/stock/${encodeURIComponent(symbol)}`;
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`fetch error: ${res.status}`);
      const json = await res.json();
      if (!Array.isArray(json) || json.length < 10) throw new Error("no/short data");
      return json;
    }

    // ===== Analyze price series to derive musical parameters =====
    function analyze(prices) {
      const start = prices[0], end = prices[prices.length - 1];
      const min = Math.min(...prices), max = Math.max(...prices);
      const mean = prices.reduce((a, b) => a + b, 0) / prices.length;
      const variance = prices.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / prices.length;
      const stdDev = Math.sqrt(variance);

      const change = end - start;
      const up = change >= 0;
      const volatility = stdDev;
      const range = max - min;

      // Map to music params
      const baseMidi = 60 + (up ? 0 : -3); // C4 base, bearish -> slightly lower
      const BPM = Math.max(80, Math.min(150, Math.round(100 + volatility))); // volatility nudges tempo
      const timeSigs = ["4/4", "3/4", "6/8", "5/4"];
      const timeSig = timeSigs[Math.floor(Math.random() * timeSigs.length)];
      const beatsPerBar = timeSig === "6/8" ? 6 : parseInt(timeSig, 10);
      const bars = 4;

      return { change, range, volatility, baseMidi, BPM, timeSig, beatsPerBar, bars, up };
    }

    // ===== Helpers =====
    function midiToHz(midi) {
      return 440 * Math.pow(2, (midi - 69) / 12);
    }
    const MAJOR = [0,2,4,5,7,9,11];
    const MINOR = [0,2,3,5,7,8,10];

    function nearestScaleStep(scale, semitone) {
      const octave = Math.floor(semitone / 12);
      const inOct = semitone - octave * 12;
      let nearest = scale[0], diff = Infinity;
      for (const s of scale) {
        const d = Math.abs(s - inOct);
        if (d < diff) { diff = d; nearest = s; }
      }
      return octave * 12 + nearest;
    }

    function buildProgression(isMajor) {
      const progressions = isMajor
        ? [[0,7,9,5], [0,5,7,0], [2,7,0,0]]
        : [[0,7,8,5], [0,3,7,0], [0,10,5,7]];
      return progressions[Math.floor(Math.random() * progressions.length)];
    }

    // ===== Play short phrase (~10s) =====
    function playPhrase(params) {
      ensureAudio();
      const t0 = audioCtx.currentTime;
      const scale = params.up ? MAJOR : MINOR;
      const prog = buildProgression(params.up);
      const beats = params.beatsPerBar * params.bars;
      const beatDur = 60 / params.BPM;
      const phraseDur = beats * beatDur;

      // Simple synth: oscillator + gain envelope
      const master = audioCtx.createGain();
      master.gain.value = 0.3;
      master.connect(audioCtx.destination);

      const osc = audioCtx.createOscillator();
      osc.type = "triangle";
      const g = audioCtx.createGain();
      g.gain.value = 0.0;
      osc.connect(g).connect(master);
      osc.start(t0);

      // Schedule notes on each beat, walking through progression
      for (let i = 0; i < beats; i++) {
        const bar = Math.floor(i / params.beatsPerBar);
        const degree = prog[bar % prog.length];
        const semitone = params.baseMidi + degree;
        const quantized = nearestScaleStep(scale, semitone);
        const hz = midiToHz(quantized);

        const start = t0 + i * beatDur;
        const end = start + beatDur * 0.9;

        osc.frequency.setValueAtTime(hz, start);

        // envelope
        g.gain.cancelScheduledValues(start);
        g.gain.setValueAtTime(0.0, start);
        g.gain.linearRampToValueAtTime(0.28, start + beatDur * 0.05);
        g.gain.linearRampToValueAtTime(0.18, start + beatDur * 0.4);
        g.gain.linearRampToValueAtTime(0.0, end);
      }

      osc.stop(t0 + phraseDur + 0.05);
      return phraseDur;
    }

    // ===== UI bindings =====
    const resultsEl = document.getElementById("results");
    const rollBtn = document.getElementById("rollBtn");
    const symbolInput = document.getElementById("symbolInput");

    rollBtn.addEventListener("click", async () => {
      try {
        ensureAudio(); // crucial for mobile
        rollBtn.disabled = true;
        rollBtn.textContent = "取得中…";

        const symbol = symbolInput.value.trim() || "7203.T";
        const prices = await fetchStock(symbol);
        const stats = analyze(prices);
        const dur = playPhrase(stats);

        // Render quick stats
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <h4>${symbol}</h4>
          <div class="badge">BPM: ${stats.BPM}</div>
          <div class="timeSig">${stats.timeSig}, bars: ${stats.bars}</div>
          <div class="label">change: ${stats.change.toFixed(2)} / range: ${stats.range.toFixed(2)} / vol: ${stats.volatility.toFixed(2)}</div>
          <div class="label">phrase: ~${dur.toFixed(1)} sec</div>
        `;
        resultsEl.prepend(card);
      } catch (e) {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `<h4>エラー</h4><div class="label">${String(e)}</div>`;
        resultsEl.prepend(card);
      } finally {
        rollBtn.disabled = false;
        rollBtn.textContent = "カプセルトイを回す";
      }
    });
  </script>
</body>
</html>
