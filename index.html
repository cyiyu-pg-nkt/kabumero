<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>株メロ♪ | カプセルトイで短い曲</title>
  <style>
    /* ===== 80年代レトロかわいいデザイン ===== */
    :root {
      --bg: #21213a;
      --panel: #2c2c4f;
      --accent-pink: #ff72b6;
      --accent-cyan: #6df0ff;
      --accent-yellow: #ffe66d;
      --accent-green: #96ff7c;
      --white: #fff7fb;
      --shadow: rgba(0,0,0,0.35);
      --btn-grad: linear-gradient(135deg, #ff72b6 0%, #ffe66d 100%);
      --ring-grad: conic-gradient(from 0deg, #ff72b6, #6df0ff, #96ff7c, #ffe66d, #ff72b6);
    }
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      height: 100%;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(255,114,182,0.25), transparent 60%),
        radial-gradient(1200px 600px at 80% 90%, rgba(109,240,255,0.18), transparent 60%),
        var(--bg);
      color: var(--white);
      font-family: "Segoe UI", "Yu Gothic UI", system-ui;
    }
    .container { max-width: 980px; margin: 0 auto; padding: 24px; }
    header { text-align: center; margin-bottom: 16px; }
    .title {
      font-weight: 900;
      font-size: 40px;
      letter-spacing: 2px;
      display: inline-block;
      padding: 10px 18px;
      background: var(--btn-grad);
      color: #1c1230;
      border-radius: 16px;
      box-shadow: 0 8px 20px var(--shadow), inset 0 -3px 0 rgba(0,0,0,0.15);
      text-shadow: 0 1px 0 rgba(255,255,255,0.6);
    }
    .catch { margin-top: 10px; font-size: 16px; color: var(--accent-yellow); text-shadow: 0 1px 0 rgba(0,0,0,0.4); }
    .sub { margin-top: 6px; font-size: 14px; color: #e9d8ff; opacity: 0.9; }
    .stage { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 24px; align-items: start; margin-top: 18px; }
    .machine { background: var(--panel); border-radius: 18px; padding: 20px; box-shadow: 0 10px 30px var(--shadow); position: relative; overflow: hidden; }
    .ring { width: 220px; height: 220px; margin: 0 auto; border-radius: 50%; background: var(--ring-grad); filter: saturate(1.3); box-shadow: 0 6px 18px var(--shadow), inset 0 0 24px rgba(255,255,255,0.25); position: relative; animation: spin 8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .capsule { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 160px; height: 160px; border-radius: 50%; background: radial-gradient(closest-side, rgba(255,255,255,0.7), rgba(255,255,255,0.05)), linear-gradient(180deg, rgba(255,114,182,0.5), rgba(255,114,182,0.05)), linear-gradient(45deg, rgba(109,240,255,0.8), rgba(109,240,255,0.15)); box-shadow: 0 4px 12px var(--shadow), inset 0 2px 12px rgba(255,255,255,0.25); }
    .handle { margin-top: 18px; display: flex; justify-content: center; }
    .btn { appearance: none; border: none; padding: 12px 20px; font-weight: 900; font-size: 16px; color: #1c1230; background: var(--btn-grad); border-radius: 14px; box-shadow: 0 6px 16px var(--shadow), inset 0 -3px 0 rgba(0,0,0,0.15); cursor: pointer; transition: transform 0.05s ease, box-shadow 0.2s ease; }
    .btn:hover { transform: translateY(-1px); }
    .btn:active { transform: translateY(1px); box-shadow: 0 4px 12px var(--shadow), inset 0 -1px 0 rgba(0,0,0,0.25); }
    .info { background: var(--panel); border-radius: 18px; padding: 18px; box-shadow: 0 10px 30px var(--shadow); }
    .info h3 { margin: 0 0 8px; font-size: 18px; color: var(--accent-cyan); text-shadow: 0 1px 0 rgba(0,0,0,0.4); }
    .info p { margin: 8px 0; font-size: 14px; line-height: 1.6; opacity: 0.9; }
    .muted { opacity: 0.85; font-size: 13px; color: #d6c9ff; }
    .results { margin-top: 22px; display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card { background: #353565; border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; padding: 12px; box-shadow: 0 6px 18px var(--shadow); }
    .card h4 { margin: 0 0 6px; font-size: 16px; color: var(--accent-yellow); }
    .meta { font-size: 13px; color: #e2e0ff; margin-top: 6px; }
    .badge { display: inline-block; padding: 4px 8px; font-size: 12px; font-weight: 800; color: #1c1230; background: var(--accent-green); border-radius: 10px; margin-right: 6px; }
    .timeSig { display: inline-block; padding: 4px 8px; font-size: 12px; font-weight: 800; color: #1c1230; background: var(--accent-cyan); border-radius: 10px; }
    footer { text-align: center; margin: 28px 0 8px; font-size: 12px; color: #bfb8ff; opacity: 0.8; }
    @media (max-width: 800px) {
      .stage { grid-template-columns: 1fr; }
      .results { grid-template-columns: 1fr; }
      .ring { width: 180px; height: 180px; }
      .capsule { width: 130px; height: 130px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">株メロ♪</div>
      <div class="catch"></div>
      <div class="sub"></div>
    </header>

    <div class="stage">
      <section class="machine" aria-label="カプセルトイ">
        <div class="ring" aria-hidden="true">
          <div class="capsule" aria-hidden="true"></div>
        </div>
        <div class="handle">
          <button id="rollBtn" class="btn">カプセルトイを回す</button>
        </div>
        <p class="muted" style="text-align:center;margin-top:10px;">クリックすると約10秒の短い曲が生成／再生されます。</p>
      </section>

      <aside class="info">
        <h3>基本コンセプト</h3>
        <p>株価の値動きで意外な音楽ができちゃう！</p>
        <h3>曲生成のルール</h3>
        <p>上昇／下降は音階、値幅は音量、ボラティリティはリズムやランダム性に反映。拍子はランダム抽選し、曲全体は一つの拍子で統一します（4/4・3/4・6/8・5/4）。</p>
        <p class="muted">禁止事項：架空企業・仮想銘柄の使用禁止／投資助言・株価情報は表示しません。</p>
      </aside>
    </div>

    <section class="results" id="results" aria-live="polite"></section>
    <footer>© 株メロ♪ カラフルPOPのレトロかわいい体験</footer>
  </div>

  <script>
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    let audioCtx = null;
    let audioReady = false; // 最初のタップでアクティブ化済みか

    function ensureAudio() {
      if (!audioCtx) audioCtx = new AudioCtx();
    }

    /* ===== TOPIX100リスト ===== */
    const TOPIX100 = [
      "1925大和ハウス工業","1928積水ハウス","2413エムスリー","2502アサヒグループホールディングス","2503キリンホールディングス",
      "2802味の素","2914日本たばこ産業","3382セブン＆アイ・ホールディングス","3402東レ","3407旭化成","4063信越化学工業",
      "4188三菱ケミカルホールディングス","4452花王","4502武田薬品工業","4503アステラス製薬","4507塩野義製薬","4519中外製薬",
      "4523エーザイ","4528小野薬品工業","4543テルモ","4568第一三共","4578大塚ホールディングス","4661オリエンタルランド",
      "4689Ｚホールディングス","4901富士フイルムホールディングス","4911資生堂","5020ＥＮＥＯＳホールディングス","5108ブリヂストン",
      "5401日本製鉄","5713住友金属鉱山","5802住友電気工業","6098リクルートホールディングス","6178日本郵政","6273ＳＭＣ",
      "6301小松製作所","6326クボタ","6367ダイキン工業","6501日立製作所","6502東芝","6503三菱電機","6594日本電産","6645オムロン",
      "6702富士通","6723ルネサスエレクトロニクス","6752パナソニック","6758ソニー","6861キーエンス","6869シスメックス",
      "6902デンソー","6920レーザーテック","6954ファナック","6971京セラ","6981村田製作所","7011三菱重工業","7201日産自動車",
      "7203トヨタ自動車","7267本田技研工業","7269スズキ","7270ＳＵＢＡＲＵ","7309シマノ","7733オリンパス","7741ＨＯＹＡ",
      "7751キヤノン","7832バンダイナムコホールディングス","7974任天堂","8001伊藤忠商事","8002丸紅","8031三井物産","8035東京エレクトロン",
      "8053住友商事","8058三菱商事","8113ユニ・チャーム","8267イオン","8306三菱ＵＦＪフィナンシャル・グループ","8308りそなホールディングス",
      "8309三井住友トラスト・ホールディングス","8316三井住友フィナンシャルグループ","8411みずほフィナンシャルグループ","8591オリックス",
      "8604野村ホールディングス","8630ＳＯＭＰＯホールディングス","8697日本取引所グループ","8725ＭＳ＆ＡＤインシュアランスグループホルディングス",
      "8750第一生命ホールディングス","8766東京海上ホールディングス","8801三井不動産","8802三菱地所","8830住友不動産","9020東日本旅客鉄道",
      "9021西日本旅客鉄道","9022東海旅客鉄道","9101日本郵船","9202ＡＮＡホールディングス","9432日本電信電話","9433ＫＤＤＩ",
      "9434ソフトバンク","9735セコム","9843ニトリホールディングス","9983ファーストリテイリング","9984ソフトバンクグループ"
    ];

    /* ===== 拍子抽選 ===== */
    const TIME_SIGNATURES = [
      { label: "4/4", weight: 0.30 },
      { label: "3/4", weight: 0.30 },
      { label: "6/8", weight: 0.25 },
      { label: "5/4", weight: 0.15 }
    ];
    function weightedPick(items) { const r = Math.random(); let acc = 0; for (const it of items) { acc += it.weight; if (r <= acc) return it; } return items[items.length - 1]; }
    function pickRandom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

    /* ===== 疑似価格生成 ===== */
    function simulatePriceSeries() {
      const len = 360;
      let price = 100 + Math.random() * 20;
      const series = [];
      for (let i=0;i<len;i++){ const drift=(Math.random()-0.5)*0.25; const shock=(Math.random()-0.5)*0.9; price=Math.max(1,price+drift+shock); series.push(price);}
      const start=series[0], end=series[series.length-1]; const min=Math.min(...series), max=Math.max(...series); const mean=series.reduce((a,b)=>a+b,0)/series.length; const variance=series.reduce((a,b)=>a+Math.pow(b-mean,2),0)/series.length; const stdDev=Math.sqrt(variance);
      return { change:end-start, range:max-min, volatility:stdDev };
    }

    /* ===== 音楽生成 ===== */
    const MAJOR=[0,2,4,5,7,9,11], NAT_MINOR=[0,2,3,5,7,8,10];
    function buildProgression(isMajor){const progressions=isMajor?[[0,7,9,5],[0,5,7,0],[2,7,0,0]]:[[0,7,8,5],[0,3,7,0],[0,10,5,7]];return progressions[Math.floor(Math.random()*progressions.length)];}
    function midiToHz(m){return 440*Math.pow(2,(m-69)/12);}
    function nearestScaleStep(scale, semitone){const octave=Math.floor(semitone/12);const inOct=semitone-octave*12;let nearest=scale[0], diff=Infinity;for(const s of scale){const d=Math.abs(s-inOct);if(d<diff){diff=d;nearest=s;}}return octave*12+nearest;}

    function deriveParams(stats, timeSig) {
      const up = stats.change >= 0;
      const scale = up ? MAJOR : NAT_MINOR;
      const baseMidi = 60 + (up ? 0 : -2);
      const beatsPerBar = timeSig === "6/8" ? 6 : parseInt(timeSig.split("/")[0],10);
      const bars = 4;
      let BPM=Math.round((bars*beatsPerBar*60)/10);
      BPM=Math.max(80,Math.min(140,BPM+Math.round(stats.volatility)*(up?1:-1)));
      const vol=Math.min(0.9,Math.max(0.18,stats.range/24));
      let randAmt=Math.min(0.5,stats.volatility/10);
      if(timeSig==="5/4"&&stats.volatility>6) randAmt=Math.min(0.65,randAmt+0.1);
      const leadTypes=["triangle","square","sine"], padTypes=["sawtooth","triangle"];
      const leadType=leadTypes[Math.floor(Math.random()*leadTypes.length)];
      const padType=padTypes[Math.floor(Math.random()*padTypes.length)];
      return { scale, baseMidi, beatsPerBar, bars, BPM, randAmt, timeSig, vol, leadType, padType };
    }

    function makeShortPlateImpulse(seconds){
      const len=Math.floor(audioCtx.sampleRate*seconds);
      const buf=audioCtx.createBuffer(2,len,audioCtx.sampleRate);
      for(let ch=0;ch<2;ch++){
        const data=buf.getChannelData(ch);
        for(let i=0;i<len;i++){
          const t=i/len;
          data[i]=(Math.random()*2-1)*(1-t)*(1-t);
        }
      }
      return buf;
    }

    function createAudioChain(vol){
      const master=audioCtx.createGain(); master.gain.value=vol;
      const lp=audioCtx.createBiquadFilter(); lp.type="lowpass"; lp.frequency.value=2400; lp.Q.value=0.7;
      const comp=audioCtx.createDynamicsCompressor(); comp.threshold.value=-20; comp.knee.value=20; comp.ratio.value=3; comp.attack.value=0.005; comp.release.value=0.2;
      const convolver=audioCtx.createConvolver(); convolver.buffer=makeShortPlateImpulse(0.5);
      const rvMix=audioCtx.createGain(); rvMix.gain.value=0.18;
      master.connect(lp); lp.connect(comp);
      comp.connect(audioCtx.destination);
      comp.connect(rvMix); rvMix.connect(convolver); convolver.connect(audioCtx.destination);
      return { master };
    }

    function scheduleTone(time,dur,f,gainNode,type="triangle"){
      const osc=audioCtx.createOscillator();
      const g=audioCtx.createGain();
      const a=0.012,d=0.08,s=0.6,r=0.10;
      osc.type=type; osc.frequency.setValueAtTime(f,time);
      g.gain.setValueAtTime(0.0001,time); g.gain.linearRampToValueAtTime(0.9,time+a); g.gain.linearRampToValueAtTime(s,time+a+d);
      g.gain.setValueAtTime(s,time+Math.max(0,dur-r)); g.gain.linearRampToValueAtTime(0.0001,time+dur);
      osc.connect(g); g.connect(gainNode); osc.start(time); osc.stop(time+dur+0.01);
    }

    function scheduleHat(time,dur,gain=0.18){
      const bufLen=Math.floor(audioCtx.sampleRate*dur);
      const buffer=audioCtx.createBuffer(1,bufLen,audioCtx.sampleRate);
      const data=buffer.getChannelData(0);
      for(let i=0;i<bufLen;i++) data[i]=Math.random()*2-1;
      const src=audioCtx.createBufferSource(); src.buffer=buffer;
      const bp=audioCtx.createBiquadFilter(); bp.type="bandpass"; bp.frequency.value=8000; bp.Q.value=0.8;
      const g=audioCtx.createGain(); g.gain.value=gain;
      src.connect(bp); bp.connect(g); g.connect(audioCtx.destination); src.start(time); src.stop(time+dur+0.01);
    }

    function compose(params){
      const spb=60/params.BPM; const prog=buildProgression(params.scale===MAJOR); const events={pads:[],melody:[],drums:[]};
      for(let bar=0;bar<params.bars;bar++){
        const root=params.baseMidi+prog[bar%prog.length], third=root+(params.scale===MAJOR?4:3), fifth=root+7;
        const start=bar*params.beatsPerBar*spb, dur=params.beatsPerBar*spb-0.08;
        [root,third,fifth].forEach(n=>events.pads.push({t:start,d:dur,f:midiToHz(n),osc:params.padType}));
        const leadNote=root+Math.floor(Math.random()*4)*2; events.melody.push({t:start,d:dur,f:midiToHz(leadNote),osc:params.leadType});
        for(let b=0;b<params.beatsPerBar;b++){
          const t=start+b*spb; if(Math.random()<0.5) events.drums.push({t:t,d:spb,type:"kick"}); else events.drums.push({t:t,d:spb,type:"hat"});
        }
      }
      return events;
    }

    function play(params){
      ensureAudio();
      if(!audioReady){
        audioCtx.resume(); // 初回のみアクティブ化
        audioReady=true;
      }
      audioCtx.resume().then(()=>{
        const { master } = createAudioChain(params.vol);
        const ev = compose(params); const t0 = audioCtx.currentTime;
        ev.pads.forEach(e=>scheduleTone(t0+e.t,e.d,e.f,master,e.osc));
        ev.melody.forEach(e=>scheduleTone(t0+e.t,e.d,e.f,master,e.osc));
        ev.drums.forEach(d=>{
          if(d.type==="kick"){
            const osc=audioCtx.createOscillator(); const g=audioCtx.createGain(); g.gain.value=0.35; osc.type="sine";
            const start=t0+d.t; osc.frequency.setValueAtTime(140,start); osc.frequency.exponentialRampToValueAtTime(55,start+d.d);
            osc.connect(g); g.connect(audioCtx.destination); osc.start(start); osc.stop(start+d.d+0.01);
          } else scheduleHat(t0+d.t,d.d,0.22);
        });
      });
    }

    function rollCapsule(){
      const selected = pickRandom(TOPIX100);
      const stats = simulatePriceSeries();
      const timeSig = weightedPick(TIME_SIGNATURES).label;
      const params = deriveParams(stats,timeSig);
      params.vol = 0.38 + Math.random()*0.2;
      play(params);

      // 結果表示
      const results = document.getElementById("results");
      const card = document.createElement("div"); card.className="card";
      card.innerHTML=`<h4>${selected}</h4>
        <div class="meta">
          <span class="badge">${stats.change>0?"UP":"DOWN"} ${stats.change.toFixed(1)}</span>
          <span class="timeSig">${timeSig}</span>
        </div>`;
      results.prepend(card);
      if(results.children.length>8) results.removeChild(results.lastChild);
    }

    document.getElementById("rollBtn").addEventListener("click",rollCapsule);
  </script>
</body>
</html>
