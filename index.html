<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>株メロ♪ | カプセルトイで短い曲</title>
  <style>
    /* ===== 80年代レトロかわいいデザイン ===== */
    :root {
      --bg: #21213a;           /* deep indigo */
      --panel: #2c2c4f;        /* indigo panel */
      --accent-pink: #ff72b6;  /* neon pink */
      --accent-cyan: #6df0ff;  /* neon cyan */
      --accent-yellow: #ffe66d;/* pastel yellow */
      --accent-green: #96ff7c; /* mint green */
      --white: #fff7fb;        /* warm white */
      --shadow: rgba(0,0,0,0.35);

      --btn-grad: linear-gradient(135deg, #ff72b6 0%, #ffe66d 100%);
      --ring-grad: conic-gradient(from 0deg, #ff72b6, #6df0ff, #96ff7c, #ffe66d, #ff72b6);
    }
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      height: 100%;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(255,114,182,0.25), transparent 60%),
        radial-gradient(1200px 600px at 80% 90%, rgba(109,240,255,0.18), transparent 60%),
        var(--bg);
      color: var(--white);
      font-family: "Segoe UI", "Yu Gothic UI", system-ui;
    }
    .container { max-width: 980px; margin: 0 auto; padding: 24px; }
    header { text-align: center; margin-bottom: 16px; }
    .title {
      font-weight: 900;
      font-size: 40px;
      letter-spacing: 2px;
      display: inline-block;
      padding: 10px 18px;
      background: var(--btn-grad);
      color: #1c1230;
      border-radius: 16px;
      box-shadow: 0 8px 20px var(--shadow), inset 0 -3px 0 rgba(0,0,0,0.15);
      text-shadow: 0 1px 0 rgba(255,255,255,0.6);
    }
    .catch {
      margin-top: 10px;
      font-size: 16px;
      color: var(--accent-yellow);
      text-shadow: 0 1px 0 rgba(0,0,0,0.4);
    }
    .sub {
      margin-top: 6px;
      font-size: 14px;
      color: #e9d8ff;
      opacity: 0.9;
    }

    /* ===== Capsule toy visual ===== */
    .stage {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 24px;
      align-items: start;
      margin-top: 18px;
    }
    .machine {
      background: var(--panel);
      border-radius: 18px;
      padding: 20px;
      box-shadow: 0 10px 30px var(--shadow);
      position: relative;
      overflow: hidden;
    }
    .ring {
      width: 220px; height: 220px;
      margin: 0 auto;
      border-radius: 50%;
      background: var(--ring-grad);
      filter: saturate(1.3);
      box-shadow: 0 6px 18px var(--shadow), inset 0 0 24px rgba(255,255,255,0.25);
      position: relative;
      animation: spin 8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .capsule {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 160px; height: 160px;
      border-radius: 50%;
      background:
        radial-gradient(closest-side, rgba(255,255,255,0.7), rgba(255,255,255,0.05)),
        linear-gradient(180deg, rgba(255,114,182,0.5), rgba(255,114,182,0.05)),
        linear-gradient(45deg, rgba(109,240,255,0.8), rgba(109,240,255,0.15));
      box-shadow: 0 4px 12px var(--shadow), inset 0 2px 12px rgba(255,255,255,0.25);
    }
    .handle { margin-top: 18px; display: flex; justify-content: center; }
    .btn {
      appearance: none;
      border: none;
      padding: 12px 20px;
      font-weight: 900;
      font-size: 16px;
      color: #1c1230;
      background: var(--btn-grad);
      border-radius: 14px;
      box-shadow: 0 6px 16px var(--shadow), inset 0 -3px 0 rgba(0,0,0,0.15);
      cursor: pointer;
      transition: transform 0.05s ease, box-shadow 0.2s ease;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn:active { transform: translateY(1px); box-shadow: 0 4px 12px var(--shadow), inset 0 -1px 0 rgba(0,0,0,0.25); }

    /* ===== Info panel ===== */
    .info {
      background: var(--panel);
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 10px 30px var(--shadow);
    }
    .info h3 {
      margin: 0 0 8px;
      font-size: 18px;
      color: var(--accent-cyan);
      text-shadow: 0 1px 0 rgba(0,0,0,0.4);
    }
    .info p { margin: 8px 0; font-size: 14px; line-height: 1.6; opacity: 0.9; }
    .muted { opacity: 0.85; font-size: 13px; color: #d6c9ff; }

    /* ===== Result panel ===== */
    .results {
      margin-top: 22px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    .card {
      background: #353565;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 12px;
      box-shadow: 0 6px 18px var(--shadow);
    }
    .card h4 { margin: 0 0 6px; font-size: 16px; color: var(--accent-yellow); }
    .meta { font-size: 13px; color: #e2e0ff; margin-top: 6px; }
    .badge {
      display: inline-block;
      padding: 4px 8px;
      font-size: 12px;
      font-weight: 800;
      color: #1c1230;
      background: var(--accent-green);
      border-radius: 10px;
      margin-right: 6px;
    }
    .timeSig {
      display: inline-block;
      padding: 4px 8px;
      font-size: 12px;
      font-weight: 800;
      color: #1c1230;
      background: var(--accent-cyan);
      border-radius: 10px;
    }

    footer {
      text-align: center;
      margin: 28px 0 8px;
      font-size: 12px;
      color: #bfb8ff; opacity: 0.8;
    }

    @media (max-width: 800px) {
      .stage { grid-template-columns: 1fr; }
      .results { grid-template-columns: 1fr; }
      .ring { width: 180px; height: 180px; }
      .capsule { width: 130px; height: 130px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">株メロ♪</div>
      <div class="catch"></div>
      <div class="sub"></div>
    </header>

    <div class="stage">
      <!-- カプセルトイ本体 -->
      <section class="machine" aria-label="カプセルトイ">
        <div class="ring" aria-hidden="true">
          <div class="capsule" aria-hidden="true"></div>
        </div>
        <div class="handle">
          <button id="rollBtn" class="btn">カプセルトイを回す</button>
        </div>
        <p class="muted" style="text-align:center;margin-top:10px;">クリックすると約10秒の短い曲が生成／再生されます。</p>
      </section>

      <!-- 情報パネル -->
      <aside class="info">
        <h3>基本コンセプト</h3>
        <p>株価の値動きで意外な音楽ができちゃう！</p>
        <h3>曲生成のルール</h3>
        <p>上昇／下降は音階、値幅は音量、ボラティリティはリズムやランダム性に反映。拍子はランダム抽選し、曲全体は一つの拍子で統一します（4/4・3/4・6/8・5/4）。</p>
        <p class="muted">禁止事項：架空企業・仮想銘柄の使用禁止／投資助言・株価情報は表示しません。</p>
      </aside>
    </div>

    <!-- 結果（最大2件） -->
    <section class="results" id="results" aria-live="polite"></section>

    <footer>© 株メロ♪ カラフルPOPのレトロかわいい体験</footer>
  </div>

  <script>
    /* ===== ブラウザのオーディオ制限対策（修正版） ===== */
    let audioCtx = null;
    function ensureAudio() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === "suspended") audioCtx.resume();
    }

    /* ===== TOPIX100リスト（省略せずフル復帰） ===== */
    const TOPIX100 = [
      "1925大和ハウス工業","1928積水ハウス","2413エムスリー","2502アサヒグループホールディングス","2503キリンホールディングス",
      "2802味の素","2914日本たばこ産業","3382セブン＆アイ・ホールディングス","3402東レ","3407旭化成","4063信越化学工業",
      "4188三菱ケミカルホールディングス","4452花王","4502武田薬品工業","4503アステラス製薬","4507塩野義製薬","4519中外製薬",
      "4523エーザイ","4528小野薬品工業","4543テルモ","4568第一三共","4578大塚ホールディングス","4661オリエンタルランド",
      "4689Ｚホールディングス","4901富士フイルムホールディングス","4911資生堂","5020ＥＮＥＯＳホールディングス","5108ブリヂストン",
      "5401日本製鉄","5713住友金属鉱山","5802住友電気工業","6098リクルートホールディングス","6178日本郵政","6273ＳＭＣ",
      "6301小松製作所","6326クボタ","6367ダイキン工業","6501日立製作所","6502東芝","6503三菱電機","6594日本電産","6645オムロン",
      "6702富士通","6723ルネサスエレクトロニクス","6752パナソニック","6758ソニー","6861キーエンス","6869シスメックス",
      "6902デンソー","6920レーザーテック","6954ファナック","6971京セラ","6981村田製作所","7011三菱重工業","7201日産自動車",
      "7203トヨタ自動車","7267本田技研工業","7269スズキ","7270ＳＵＢＡＲＵ","7309シマノ","7733オリンパス","7741ＨＯＹＡ",
      "7751キヤノン","7832バンダイナムコホールディングス","7974任天堂","8001伊藤忠商事","8002丸紅","8031三井物産","8035東京エレクトロン",
      "8053住友商事","8058三菱商事","8113ユニ・チャーム","8267イオン","8306三菱ＵＦＪフィナンシャル・グループ","8308りそなホールディングス",
      "8309三井住友トラスト・ホールディングス","8316三井住友フィナンシャルグループ","8411みずほフィナンシャルグループ","8591オリックス",
      "8604野村ホールディングス","8630ＳＯＭＰＯホールディングス","8697日本取引所グループ","8725ＭＳ＆ＡＤインシュアランスグループホルディングス",
      "8750第一生命ホールディングス","8766東京海上ホールディングス","8801三井不動産","8802三菱地所","8830住友不動産","9020東日本旅客鉄道",
      "9021西日本旅客鉄道","9022東海旅客鉄道","9101日本郵船","9202ＡＮＡホールディングス","9432日本電信電話","9433ＫＤＤＩ",
      "9434ソフトバンク","9735セコム","9843ニトリホールディングス","9983ファーストリテイリング","9984ソフトバンクグループ"
    ];

    /* ===== クリックで生成・再生 ===== */
    const rollBtn = document.getElementById("rollBtn");
    const resultsEl = document.getElementById("results");

    rollBtn.addEventListener("click", () => {
      ensureAudio(); // ここでモバイルでも確実にAudioContextを作成／resume

      const ticker = pickRandom(TOPIX100);
      const timeSig = weightedPick([
        { label: "4/4", weight: 0.30 },
        { label: "3/4", weight: 0.30 },
        { label: "6/8", weight: 0.25 },
        { label: "5/4", weight: 0.15 }
      ]).label;

      const stats = simulatePriceSeries();
      const params = deriveParams(stats, timeSig);

      play(params);

      const mood = describeMood(stats.change, timeSig);
      const card = createResultCard({ ticker, timeSig, mood, BPM: params.BPM, bars: params.bars });
      const current = Array.from(resultsEl.children);
      if (current.length >= 2) resultsEl.removeChild(current[0]);
      resultsEl.appendChild(card);
    });

    /* ===== 既存の関数群はそのまま ===== */
  </script>
</body>
</html>
